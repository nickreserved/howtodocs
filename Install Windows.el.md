# Οδηγός: Εγκατάσταση των Windows με DISM


## Γιατί;

Αν εγκαθιστάτε πολλές φορές τα Windows σε πολλά μηχανήματα, είναι αρκετά βαρετή και κουραστική διαδικασία.

Παράλληλα, πάρα πολλοί χρήστες απεχθάνονται κάποιες δυνατότητες των Windows και εύχονται να μην υπήρχαν.

Η μέθοδος αυτή παρέχει έναν τρόπο να αποκτάτε μια εικόνα των Windows έτοιμη για εγκατάσταση, με όλες τις ενημερώσεις και με όλα τα λοιπά προγράμματα, τις ρυθμίσεις τους, παιχνίδια, λοιπά αρχεία, χρήστες και ρυθμίσεις και προτιμήσεις χρηστών.

Η μέθοδος αφορά οποιαδήποτε έκδοση Windows από Windows XP και εξής.


## Βήμα 1: Εγκατάσταση και Συντήρηση των Windows σε VirtualBox.

Έχουμε εγκαταστήσει στο VirtualBox τα Windows.
- Έχουμε κάνει ενημερώσεις.
- Έχουμε εγκαταστήσει τις γλώσσες που θέλουμε.
- Έχουμε ρυθμίσει τα Windows.
- Έχουμε δημιουργήσει τους χρήστες που θέλουμε και τους έχουμε ρυθμίσει έναν-έναν.
- Έχουμε εγκαταστήσει όλα τα λοιπά προγράμματα και παιχνίδια που θέλουμε, τα έχουμε ρυθμίσει και τα έχουμε κάνει ενημέρωση (π.χ. 7-Zip, Notepad3, Mozilla Firefox κτλ).

Με λίγα λόγια, έχουμε ένα περιβάλλον Windows, πλήρως λειτουργικό για καθημερινή χρήση, σε VirtualBox.


## Βήμα 2: Λήψη Εικόνας από το VirtualBox

- Θέτουμε στο VirtualBox, το δίκτυο στο εικονικό μηχάνημα των Windows σε γεφυρωμένο (και όχι σε NAT). Αυτό απαιτείται για να έχουμε πρόσβαση στους κοινόχρηστους φακέλους του φυσικού μηχανήματος.
- Εκκινούμε στο VirtualBox, το σύστημα-πελάτη των Windows, έχοντας εισάγει το DVD των Windows PE και εκκινούμε τα Windows PE.
  - Προσοχή. Όχι των Windows RE.
  - Χρησιμοποιήστε το Windows 11 PE x64 για 64 bit μηχανήματα-πελάτη και το Windows 10 PE x32 για 32 bit μηχανήματα-πελάτη.
  - Κάποια στιγμή θα ανεβάσω ένα torrent με τα δικά μου Windows PE ISO. Δυστυχώς είναι λίγο δύσκολο να τα κατασκευάσετε. Η Microsoft παρέχει πάντως αναλυτικές οδηγίες. **ΑΠΑΙΤΕΙΤΑΙ ΕΠΕΚΤΑΣΗ ΤΗΣ ΠΑΡΑΓΡΑΦΟΥ**.
- Εντοπίζουμε το δίσκο με τα Windows, ο οποίος πιθανότατα είναι ο C: ή ο D:. Ας πούμε ότι είναι ο C:
- Προσαρτούμε το δίσκο του φυσικού μηχανήματος με την εντολή:
```Shell
NET USE * \\10.0.0.2\nas /user:chameleon
```
και δίνουμε κωδικό πρόσβασης. Ο δίσκος προσαρτείται πάντα στο Z:
- Μπορείτε τώρα να σβήσετε κάποια αχρείαστα αρχεία των Windows στο δίσκο C:. Μην ανησυχείτε για τα αρχεία `hiberfil.sys`, `pagefile.sys`, `swapfile.sys`. Αυτά δεν αντιγράφονται ποτέ στην τελική εικόνα.
- Για να πάρουμε εικόνα εκτελούμε την εντολή:
```Shell
DISM /Capture-Image /ImageFile:"Z:\install.wim" /CaptureDir:C:\ /Name:"Windows 10"
```
- Όταν ολοκληρωθεί η λήψη εικόνας, τερματίζουμε το εικονικό περιβάλλον του VirtualBox.

Εναλλακτικά, αν δεν θέλουμε να κάνουμε προσάρτηση τον δίσκο του οικοδεσπότη με `NET USE` και έχουμε αρκετό χώρο στο δίσκο-πελάτη του συστήματος πελάτη, μπορούμε να κάνουμε τα παρακάτω:
- Λαμβάνουμε εικόνα των Windows τοπικά, στον δίσκο-πελάτη, με την εντολή
```Shell
DISM /Capture-Image /ImageFile:"C:\install.wim" /CaptureDir:C:\ /Name:"Windows 10"
```
- Όταν τελειώσει η λήψη εικόνας, τερματίζουμε το εικονικό περιβάλλον του VirtualBox.
- Λαμβάνουμε την εικόνα, ανοίγοντας τον εικονικό δίσκο `.vdi` του VirtualBox με το ImDisk ή το 7-Zip και εξάγωντας το αρχείο εικόνας install.wim.


## Βήμα 3: Αφαίρεση Χαρακτηριστικών από τα Windows με το MSMG Toolkit

Αν κάποιες δυνατότητες των Windows σας εκνευρίζουν μπορείτε να τις αφαιρέσετε με το [MSMGToolkit](https://msmgtoolkit.in/).
- Αποσυμπιέστε το MSMGToolkit στο φάκελο `C:\MSMGToolkit`.
- Αντιγράψτε (προσοχή! όχι μετακινήστε! Αντιγράψτε για να έχετε αντίγραφο ασφαλείας αν το MSMGToolkit καταστρέψει το αρχείο WIM) το αρχείο `C:\install.wim` στο φάκελο `C:\MSMGToolkit\DVD\sources`.
- Ανοίξτε με το πρόγραμμα 7-Zip ένα Windows ISO, βρείτε ένα αρχείο `boot.wim` και αποσυμπιέστε το στον παραπάνω φάκελο `C:\MSMGToolkit\DVD\sources`. Το αρχείο αυτό δεν απαιτείται πουθενά, αλλά το MSMGToolkit το ζητάει για να συνεχίσει.
- Εκτελέστε το MSMGToolkit και αφαιρέστε όποια δυνατότητα των Windows δεν θέλετε.
- Πριν εγκαταστήσετε την εικόνα σε κάποιο φυσικό μηχάνημα, μπορείτε να την εγκαταστήσετε σε ένα εικονικό στο VirtualBox για να δείτε αν λειτουργεί.


## Βήμα 4: Εγκατάσταση των Windows


### Εκκίνηση στον Υπολογιστή που θα εγκαταστήσουμε τα Windows

- Μετατρέπουμε ένα USB αποθηκευτικό μέσο σε εκκινήσιμο, με το πρόγραμμα [YUMI](https://pendrivelinux.com/yumi-multiboot-usb-creator/) και εγκαθιστούμε σε αυτό με το ίδιο πρόγραμμα το Windows PE ISO.
- Αν το USB αποθηκευτικό μέσο έχει αρκετό χώρο, μπορούμε να αντιγράψουμε και το `install.wim` μέσα, αλλά δεν απαιτείται. Στη συνέχεια του οδηγού θα θεωρούμε ότι το λαμβάνουμε από άλλο υπολογιστή μέσω LAN.
- Εκκινούμε τον υπολογιστή που θα εγκαταστήσουμε τα Windows, έχοντας σαν πρώτη προτεραιότητα για εκκίνηση το USB αποθηκευτικό μέσο. Επιλέγουμε εκκίνηση με Windows PE.
- Εφαρμόζουμε **ένα** από τα παρακάτω Α, Β ή Γ τμήματα για κατατμήσεις και διαμορφώσεις. Ακολούθως, συνεχίζουμε παρακάτω.
- Όλα τα επόμενα βήματα πρέπει να εφαρμοστούν **επακριβώς** ειδάλλως τα Windows μετά την εγκατάσταση δεν θα εκκινούν καθόλου.


### Α. Χωρίς Κατατμήσεις και Διαμόρφωση Δίσκων (Υπήρχαν Εγκατεστημένα Windows)

Αν υπήρχαν ήδη εγκατεστημένα Windows στο δίσκο και δεν θέλουμε να αλλάξουμε τις κατατμήσεις, εφαρμόζουμε τα παρακάτω βήματα.

Βεβαιωνόμαστε όμως, ότι δεν είχαμε MBR δίσκο και τα νέα Windows απαιτούν GPT ή δεν είχαμε GPT και τα νέα Windows δεν μπορούν να εκκινήσουν με GPT.

- Θεωρούμε ότι ο οδηγός με τα εγκατεστημένα Windows είναι ο C:
- Μετονομάζουμε τους βασικούς φακέλους για να μην έχουμε πρόβλημα με την νέα εγκατάσταση:
```Shell
ren C:\Windows C:\Windows_OLD
ren "C:\Program Files" C:\ProgramFiles_OLD
ren "C:\Program Files (x86)" C:\ProgramFiles86_OLD
ren C:\Users C:\Users_OLD
ren C:\ProgramData C:\ProgramData_OLD
```
- Βεβαιωνόμαστε ότι θα χωρέσουν τα νέα Windows διατηρώντας τα παλιά, ειδάλλως αντί να μετονομάσουμε τους φακέλους τους διαγράφουμε (τουλάχιστον κάποιους από αυτούς - τους υπόλοιπους τους μετονομάζουμε):
```Shell
rmdir /q /s C:\Windows
rmdir /q /s "C:\Program Files"
rmdir /q /s "C:\Program Files (x86)"
rmdir /q /s C:\Users
rmdir /q /s C:\ProgramData
```


### Β. Κατατμήσεις και Διαμόρφωση Δίσκων για BIOS/MBR PC

Η μέθοδος αυτή λειτουργεί μέχρι και Windows 10. Στα Windows 11 λειτουργεί αν είναι σπασμένα, ειδάλλως θα πρέπει να τα εγκαταστήσετε με τη μέθοδο για UEFI/GPT PC.

Με τη μέθοδο αυτή μπορείτε να έχετε μέχρι 4 κατατμήσεις μέγιστου μεγέθους 2 TB η κάθε μία.

- Εκτελούμε την εντολή
```Shell
diskpart
```
  - Στη γραμμή εντολών του `diskpart` εκτελούμε τις παρακάτω εντολές:
```Shell
list disk                               # Για να δούμε τους δίσκους στον υπολογιστή
select disk 0                           # Επιλέγουμε το δίσκο που θα γίνει η εγκατάσταση. ΠΡΟΣΟΧΗ ΜΗΝ ΕΠΙΛΕΞΕΤΕ ΛΑΘΟΣ ΔΙΣΚΟ!
list partition                          # Για να δούμε τις κατατμήσεις στον υπολογιστή
list volume                             # Για να δούμε τους οδηγούς στον υπολογιστή (π.χ. C:, D: κτλ)
clean                                   # Διαγράφουμε όλα του τα δεδομένα
create partition primary                # Δημιουργούμε την κατάτμηση που θα εγκαταστήσουμε τα Windows
format quick fs=ntfs label="Windows"    # Τη διαμορφώνουμε σε NTFS σύστημα αρχείων με όνομα "Windows"
                                        # Αν δεν κάνετε διαμόρφωση με ακριβώς αυτό τον τρόπο μέσα από το diskpart, τα Windows δεν θα εκκινούν
assign letter="C"                       # Της αναθέτουμε το γράμμα C: (δώστε άλλο αν το C: έχει ανατεθεί σε άλλο οδηγό)
active                                  # Την κάνουμε εκκινήσιμη
exit                                    # Τερματίζουμε το diskpart
```


### Γ. Κατατμήσεις και Διαμόρφωση Δίσκων για UEFI/GPT PC

Η μέθοδος αυτή λειτουργεί από Windows 7 και μόνο αν ο υπολογιστής υποστηρίζει εκκίνηση UEFI.

**ΠΡΟΣΟΧΗ!** Αν η εγκατάσταση γίνεται σε VirtualBox, θα πρέπει **προ** της εκκίνησης, να είναι ενεργοποιημένο το EFI. Αν δεν είναι πριν εκτελεστεί το `diskpart`, δεν θα εκκινούν τα Windows.

Εναλλακτικά, χωρίς ο υπολογιστής να υποστηρίζει εκκίνηση UEFI, υπάρχει δυνατότητα μέσω grub και άλλων προγραμμάτων, αλλά δεν το έχω ψάξει.

Πρακτικά δεν υπάρχουν περιορισμοί σε αριθμό κατατμήσεων και σε μέγιστο μέγεθος κατάτμησης.

- Εκτελούμε την εντολή
```Shell
diskpart
```
  - Στη γραμμή εντολών του `diskpart` εκτελούμε τις παρακάτω εντολές:
```Shell
list disk                               # Για να δούμε τους δίσκους στον υπολογιστή
select disk 0                           # Επιλέγουμε το δίσκο που θα γίνει η εγκατάσταση. ΠΡΟΣΟΧΗ ΜΗΝ ΕΠΙΛΕΞΕΤΕ ΛΑΘΟΣ ΔΙΣΚΟ!
list partition                          # Για να δούμε τις κατατμήσεις στον υπολογιστή
list volume                             # Για να δούμε τους οδηγούς στον υπολογιστή (π.χ. C:, D: κτλ)
clean                                   # Διαγράφουμε όλα του τα δεδομένα
convert gpt                             # Μετατρέπουμε το δίσκο σε GPT (από MBR που πιθανόν να ήταν)
create partition efi size=100           # Δημιουργούμε την κατάτμηση που θα εγκαταστήσουμε το σύστημα εκκίνησης των Windows, μεγέθους 100 MB
format quick fs=fat32 label="System"    # Τη διαμορφώνουμε σε FAT32 σύστημα αρχείων με όνομα "System"
assign letter="S"                       # Της αναθέτουμε το γράμμα S:
create partition msr size=16            # Δημιουργούμε μια κρυφή κατάτμηση που απαιτούν τα Windows, μεγέθους 16 MB - Δεν χρειάζεται διαμόρφωση
create partition primary                # Δημιουργούμε την κατάτμηση που θα εγκαταστήσουμε τα Windows
format quick fs=ntfs label="Windows"    # Τη διαμορφώνουμε σε NTFS σύστημα αρχείων με όνομα "Windows"
assign letter="C"                       # Της αναθέτουμε το γράμμα C: (δώστε άλλο αν το C: έχει ανατεθεί σε άλλο οδηγό)
exit                                    # Τερματίζουμε το diskpart
```


### Εγκατάσταση της Εικόνας των Windows

- Προσαρτούμε το δικτυακό μέσο αποθήκευσης (το οποίο προσαρτάται πάντα στο γράμμα Z:) με την παρακάτω εντολή: (εκτός κι αν έχουμε την εικόνα των Windows στο USB μέσο αποθήκευσης)
```Shell
NET USE * \\10.0.0.2\nas /user:chameleon
```
- Εγκαθιστούμε την εικόνα των Windows με την παρακάτω εντολή
```Shell
dism /Apply-Image /ImageFile:Z:\install.wim /Index:1 /ApplyDir:C:\
```
- Ανάλογα αν επιλέξαμε UEFI/GPT κατατμήσεις ή BIOS/MBR, εφαρμόζουμε **ένα** από τα παρακάτω Α, Β, Γ ή Δ τμήματα για να κάνουμε τα Windows εκκινήσιμα.


### Α. Εκκινήσημα Windows αν Υπήρχαν Εγκατεστημένα Windows

Καμία ενέργεια


### Β. Εκκινήσιμα Windows για BIOS/MBR PC

- Εκτελούμε την εντολή:
```Shell
bcdboot C:\Windows /S C: /F BIOS /L el-GR /V
```


### Γ. Εκκινήσιμα Windows για UEFI/GPT PC

- Εκτελούμε την εντολή:
```Shell
bcdboot C:\Windows /s C:
```

### Δ. Υπάρχει partition με Linux και η Επιλογή Λειτουργικού για Εκκίνηση Γίνεται με grub

- Κάνουμε grub-update για να εντοπίσει το νέο λειτουργικό (πιθανόν να μην χρειάζεται αν υπήρχαν ήδη Windows στην ίδια κατάτμηση).


### Τερματισμός

- Εκτελούμε την εντολή
```Shell
exit
```
- Αφαιρούμε το USB μέσο αποθήκευσης
- Αν όλα πήγαν καλά, θα εκκινηθούν τα Windows που μόλις εγκαταστήσαμε
